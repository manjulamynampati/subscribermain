<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unsubscribe Page</title>
</head>
<body>
<h1>Unsubscribe from Publishers</h1>
<form id="unsubscribeForm">
    <!-- Checkbox list will be populated here -->
    <button type="button" onclick="unsubscribe()">Unsubscribe</button>
</form>

<script>
    // Get selectedPublishers from the URL
    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    var publishersParam = urlParams.get('publishers');
    const selectedPublishers = JSON.parse(decodeURIComponent(publishersParam));
    const subscriberId = urlParams.get('subscriberId');

    console.log('Subscriber ID:', subscriberId);
    console.log(selectedPublishers);

    // Populate checkboxes
    var form = document.getElementById('unsubscribeForm');
    selectedPublishers.forEach(publisher => {
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'publishers';
        checkbox.value = publisher;
        checkbox.id = publisher;


        var label = document.createElement('label');
        label.htmlFor = publisher;
        label.appendChild(document.createTextNode(publisher));

        form.appendChild(checkbox);
        form.appendChild(label);
        form.appendChild(document.createElement('br'));
    });

    // Function to handle the Unsubscribe button click
    function unsubscribe() {
        // Get the selected publishers
        var selectedPublishers = [];
        var checkboxes = document.getElementsByName('publishers');
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedPublishers.push(checkbox.value);
            }
        });


        // Replace the ec2 subscriber URL

        var ec2url = 'http://ec2-54-82-71-245.compute-1.amazonaws.com:8082';
        var getUnsubscribeUrl = ec2url + '/unsubscribe';

        var data = {

            selectedPublishers: selectedPublishers,
            unsubscribeUrl : ec2url,
            subscriberId : subscriberId

        };

        fetch(getUnsubscribeUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => response.text())
            .then(data => {
                if (data === "200") {
                    alert("Unsubscribe successful:");
                }else {
                    alert("Subscription failed!");
                }

            })
            .catch(error => {
                console.error('Error in unsubscribing:', error);

            });
    }
</script>
</body>
</html>
